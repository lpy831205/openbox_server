import{_ as j,a as K,y as U,r as p,o as O,c as l,d as b,e as f,g as e,w as s,n,t as d,f as m,k as G,Z as H,K as J,L as Q,p as W,j as X,M as A,E as k,$ as B}from"./index-IjbujgFK.js";import"./crypto-wasm-7Ru5Q_sa.js";const Y={class:"profile-container"},ee={class:"card-header"},se={key:0,class:"ml-2 failure-reason"},oe={class:"dialog-footer"},ae={__name:"Profile",setup(le){const w=K(),g=U(()=>w.userInfo),I=U(()=>w.deviceCode),x=p([]),u=p(!1),v=p(!1),r=p({oldPassword:"",newPassword:"",confirmPassword:""}),i=p(null),L={oldPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"},{pattern:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{6,}$/,message:"密码必须包含大小写字母和数字",trigger:"blur"}],confirmPassword:[{required:!0,message:"请再次输入新密码",trigger:"blur"},{validator:(t,o,c)=>{o!==r.value.newPassword?c(new Error("两次输入的密码不一致")):c()},trigger:"blur"}]},N=async()=>{try{const t=await A.post("/api/auth/login-records");x.value=t}catch(t){k.error("获取登录记录失败："+t.message)}},S=()=>{r.value={oldPassword:"",newPassword:"",confirmPassword:""},u.value=!0,B(()=>{i.value&&i.value.resetFields()})},h=async()=>{if(i.value)try{await i.value.validate(),v.value=!0,await A.post("/api/auth/update-password",{old_password:r.value.oldPassword,new_password:r.value.newPassword}),k.success("密码修改成功，请重新登录"),u.value=!1,await B(),w.logout()}catch(t){t&&t.message?k.error("修改密码失败："+t.message):console.log("表单校验失败或API请求被取消/无消息错误:",t)}finally{v.value=!1}},C=t=>t?new Date(t).toLocaleString():"";return O(()=>{N()}),(t,o)=>{const c=l("el-icon"),P=l("el-button"),_=l("el-descriptions-item"),q=l("el-descriptions"),E=l("el-card"),F=l("el-col"),z=l("el-tag"),D=l("el-timeline-item"),M=l("el-timeline"),R=l("el-row"),y=l("el-input"),V=l("el-form-item"),T=l("el-form"),Z=l("el-dialog");return f(),b("div",Y,[e(R,{gutter:20},{default:s(()=>[e(F,{span:12},{default:s(()=>[e(E,{class:"profile-card"},{header:s(()=>[m("div",ee,[o[6]||(o[6]=m("span",null,"个人信息",-1)),e(P,{type:"primary",onClick:S},{default:s(()=>[e(c,null,{default:s(()=>[e(G(H))]),_:1}),o[5]||(o[5]=n(" 修改密码 "))]),_:1})])]),default:s(()=>[e(q,{column:1,border:""},{default:s(()=>[e(_,{label:"账号"},{default:s(()=>[n(d(g.value.account),1)]),_:1}),e(_,{label:"角色"},{default:s(()=>[n(d(g.value.role==="admin"?"管理员":"普通用户"),1)]),_:1}),e(_,{label:"设备码"},{default:s(()=>[n(d(I.value),1)]),_:1}),e(_,{label:"注册时间"},{default:s(()=>[n(d(C(g.value.registerTime)),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(F,{span:12},{default:s(()=>[e(E,{class:"login-record-card"},{header:s(()=>o[7]||(o[7]=[m("div",{class:"card-header"},[m("span",null,"登录记录")],-1)])),default:s(()=>[e(M,null,{default:s(()=>[(f(!0),b(J,null,Q(x.value,(a,$)=>(f(),W(D,{key:$,timestamp:C(a.time),type:a.status==="success"?"success":"danger"},{default:s(()=>[n(d(a.ip)+" ",1),e(z,{type:a.status==="success"?"success":"danger",size:"small",class:"ml-2"},{default:s(()=>[n(d(a.status==="success"?"登录成功":"登录失败"),1)]),_:2},1032,["type"]),a.status==="failed"&&a.reason?(f(),b("span",se," 原因: "+d(a.reason),1)):X("",!0)]),_:2},1032,["timestamp","type"]))),128))]),_:1})]),_:1})]),_:1})]),_:1}),e(Z,{modelValue:u.value,"onUpdate:modelValue":o[4]||(o[4]=a=>u.value=a),title:"修改密码",width:"400px","destroy-on-close":""},{footer:s(()=>[m("span",oe,[e(P,{onClick:o[3]||(o[3]=a=>u.value=!1)},{default:s(()=>o[8]||(o[8]=[n("取消")])),_:1}),e(P,{type:"primary",onClick:h,loading:v.value},{default:s(()=>o[9]||(o[9]=[n(" 确认 ")])),_:1},8,["loading"])])]),default:s(()=>[e(T,{ref_key:"passwordFormEl",ref:i,model:r.value,rules:L,"label-position":"top"},{default:s(()=>[e(V,{label:"当前密码",prop:"oldPassword"},{default:s(()=>[e(y,{modelValue:r.value.oldPassword,"onUpdate:modelValue":o[0]||(o[0]=a=>r.value.oldPassword=a),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(V,{label:"新密码",prop:"newPassword"},{default:s(()=>[e(y,{modelValue:r.value.newPassword,"onUpdate:modelValue":o[1]||(o[1]=a=>r.value.newPassword=a),type:"password","show-password":""},null,8,["modelValue"])]),_:1}),e(V,{label:"确认新密码",prop:"confirmPassword"},{default:s(()=>[e(y,{modelValue:r.value.confirmPassword,"onUpdate:modelValue":o[2]||(o[2]=a=>r.value.confirmPassword=a),type:"password","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},ne=j(ae,[["__scopeId","data-v-c710eaf8"]]);export{ne as default};
